<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>봉사 신청 관리</title>
    <!-- <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    /> -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      .main-content {
        padding: 20px;
      }
      .application-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .application-table th,
      .application-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
      }
      .application-table th {
        background-color: #f2f2f2;
      }
      .application-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .application-table td input[type="checkbox"] {
        cursor: pointer;
      }
      .action-buttons {
        margin-top: 20px;
        text-align: right;
      }
      .action-buttons button,
      .action-buttons a {
        padding: 8px 15px;
        margin-left: 10px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block; /* 링크도 버튼처럼 보이게 */
      }
      .approve-btn {
        background-color: #4caf50; /* 초록색 */
        color: white;
        border: none;
      }
      .reject-btn {
        background-color: #f44336; /* 빨간색 */
        color: white;
        border: none;
      }
      .excel-btn {
        background-color: #2196f3; /* 파란색 */
        color: white;
        border: none;
      }
      /* 상태별 스타일 */
      .status-pending {
        color: #ff9800; /* 주황색 */
        font-weight: bold;
      }
      .status-approved {
        color: #4caf50; /* 녹색 */
        font-weight: bold;
      }
      .status-rejected {
        color: #f44336; /* 빨간색 */
        font-weight: bold;
      }
    </style>
  </head>
  <body class="{{ body_class or '' }}">
    <div class="main-container">
      <div class="user-info-container">
        <div class="user-info">
          <span id="userName"></span>
          <span id="userEmail"></span>
          <!-- <span id="adminStatus"></span> -->
          <button id="logoutBtn" class="logout-btn">로그아웃</button>
        </div>
      </div>

      <div class="sidebar">
        <h2>메뉴</h2>
        <ul>
          {# 홈 - 모든 사용자에게 표시 #}
          <li><a href="/main">홈</a></li>

          {# 봉사 등록 - admin@test.com 이 아닌 승인된 관리자에게만 표시 #} {%
          if current_user and current_user.is_admin and current_user.email !=
          'admin@test.com' %}
          <li><a href="/register-volunteer">봉사 등록</a></li>
          {% endif %} {# 봉사 관리 - admin@test.com 이 아닌 승인된 관리자에게만
          표시 (현재 페이지이므로 active) #} {% if current_user and
          current_user.is_admin and current_user.email != 'admin@test.com' %}
          <li><a href="/manage-volunteers" class="active">봉사 관리</a></li>
          {% endif %} {# 프로필 - 모든 사용자에게 표시 #}
          <li><a href="/profile">프로필</a></li>

          {# 관리자 인증 - admin@test.com 이 아닌 사용자에게만 표시 #} {% if
          current_user and current_user.email != 'admin@test.com' %}
          <li><a href="/admin-verification">관리자 인증</a></li>
          {% endif %} {# 관리자 승인 - admin@test.com 사용자에게만 표시 #} {% if
          current_user and current_user.email == 'admin@test.com' %}
          <li><a href="/admin/approve-requests">관리자 승인</a></li>
          {% endif %}
        </ul>
      </div>

      <div class="main-content">
        <h2>봉사 신청 관리</h2>

        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %} {% endwith %}

        <table class="application-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllCheckbox" /></th>
              <th>순번</th>
              <th>봉사 제목</th>
              <th>회원명</th>
              <th>회원ID</th>
              <th>활동일자</th>
              <th>신청날짜</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody>
            {% for app in applications %}
            <tr>
              <td>
                <input
                  type="checkbox"
                  class="application-checkbox"
                  value="{{ app.id }}"
                  {%
                  if
                  app.status
                  !="pending"
                  %}disabled{%
                  endif
                  %}
                />
              </td>
              <td>{{ loop.index }}</td>
              <td>{{ app.activity_title or '-' }}</td>
              <td>{{ app.applicant_name }}</td>
              <td>{{ app.applicant_email }}</td>
              <td>{{ app.volunteer_date }}</td>
              <td>
                {{ app.application_date[:16] if app.application_date else '-' }}
              </td>
              {# YYYY-MM-DD HH:MM #}
              <td
                class="{% if app.status == 'pending' %}status-pending {% elif app.status == 'approved' %}status-approved {% elif app.status == 'rejected' %}status-rejected {% endif %}"
              >
                {{ app.status | replace('pending', '대기') | replace('approved',
                '승인') | replace('rejected', '반려') }}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8">아직 봉사 신청 내역이 없습니다.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="action-buttons">
          <button id="approveSelectedBtn" class="approve-btn">선택 승인</button>
          <button id="rejectSelectedBtn" class="reject-btn">선택 반려</button>
          <a href="/download-applications" class="excel-btn">엑셀 다운로드</a>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = ""; // 로컬 테스트용 API 주소 설정

      // 현재 사용자 정보 로드
      async function loadUserInfo() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/current-user`);
          const data = await response.json();
          if (data.success) {
            document.getElementById("userName").textContent = data.name;
            document.getElementById("userEmail").textContent = data.email;
            // const adminStatusEl = document.getElementById("adminStatus"); // adminStatus 요소 참조 제거
            /* // adminStatus 업데이트 로직 제거
            if (adminStatusEl)
              adminStatusEl.textContent = data.is_admin
                ? "관리자 인증 완료"
                : "관리자 인증 필요";
            */
          } else {
            // 로그인되지 않은 경우 로그인 페이지로 리디렉션 등 처리
            window.location.href = "/login";
          }
        } catch (error) {
          console.error("사용자 정보 로드 실패:", error);
          // window.location.href = "/login";
        }
      }

      // 로그아웃 처리
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            const response = await fetch(`${API_BASE_URL}/api/logout`, {
              method: "POST",
            }); // 수정
            if (response.ok) {
              window.location.href = "/login";
            } else {
              alert("로그아웃 실패");
            }
          } catch (error) {
            console.error("로그아웃 실패:", error);
            alert("로그아웃 중 오류 발생");
          }
        });

      // 전체 선택 체크박스 기능
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const applicationCheckboxes = document.querySelectorAll(
        ".application-checkbox:not([disabled])"
      ); // 비활성화되지 않은 체크박스만

      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", (event) => {
          applicationCheckboxes.forEach((checkbox) => {
            checkbox.checked = event.target.checked;
          });
        });
      }

      // 개별 체크박스 변경 시 전체 선택 체크박스 상태 업데이트
      applicationCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (selectAllCheckbox) {
            const allChecked = Array.from(applicationCheckboxes).every(
              (cb) => cb.checked
            );
            selectAllCheckbox.checked = allChecked;
          }
        });
      });

      // 선택된 항목 상태 업데이트 함수
      async function updateSelectedStatus(status) {
        const selectedIds = Array.from(applicationCheckboxes)
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => checkbox.value);

        if (selectedIds.length === 0) {
          alert("먼저 처리할 신청 항목을 선택해주세요.");
          return;
        }

        const actionText = status === "approved" ? "승인" : "반려";
        let rejectionReason = null; // 반려 사유 변수 초기화

        // 반려 처리 시 사유 입력 받기
        if (status === "rejected") {
          rejectionReason = prompt(
            `선택된 ${selectedIds.length}개의 신청을 반려합니다. 반려 사유를 입력해주세요:`
          );
          if (rejectionReason === null) {
            // 사용자가 취소 버튼을 누른 경우
            alert("반려 처리가 취소되었습니다.");
            return;
          }
          if (!rejectionReason.trim()) {
            // 사유를 입력하지 않은 경우
            alert("반려 사유를 입력해야 합니다.");
            return;
          }
          rejectionReason = rejectionReason.trim(); // 앞뒤 공백 제거
        } else {
          // 승인 시 확인 메시지
          if (
            !confirm(
              `선택된 ${selectedIds.length}개의 신청을 ${actionText} 처리하시겠습니까?`
            )
          ) {
            return;
          }
        }

        // API 요청 데이터 구성
        const requestData = {
          ids: selectedIds,
          status: status,
        };
        if (status === "rejected") {
          requestData.reason = rejectionReason; // 반려 시 사유 추가
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/update-application-status`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData), // 수정된 데이터 전송
            }
          );
          const data = await response.json();
          alert(
            data.message ||
              (data.success
                ? `${actionText} 처리가 완료되었습니다.`
                : `${actionText} 처리 중 오류가 발생했습니다.`)
          );
          if (data.success) {
            window.location.reload(); // 성공 시 페이지 새로고침
          }
        } catch (error) {
          console.error(`선택 ${actionText} 처리 중 오류:`, error);
          alert(`${actionText} 처리 중 오류가 발생했습니다.`);
        }
      }

      // 승인 버튼 이벤트 리스너
      const approveBtn = document.getElementById("approveSelectedBtn");
      if (approveBtn) {
        approveBtn.addEventListener("click", () =>
          updateSelectedStatus("approved")
        );
      }

      // 반려 버튼 이벤트 리스너
      const rejectBtn = document.getElementById("rejectSelectedBtn");
      if (rejectBtn) {
        rejectBtn.addEventListener("click", () =>
          updateSelectedStatus("rejected")
        );
      }

      // 페이지 로드 시 사용자 정보 로드
      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>
  </body>
</html>
